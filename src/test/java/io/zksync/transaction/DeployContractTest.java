package io.zksync.transaction;

import static org.junit.jupiter.api.Assertions.*;

import java.math.BigInteger;
import java.util.Iterator;
import java.util.List;

import org.apache.commons.lang3.tuple.Pair;
import org.junit.Test;
import org.web3j.abi.FunctionEncoder;
import org.web3j.abi.datatypes.Function;
import org.web3j.abi.datatypes.Type;
import org.web3j.abi.datatypes.generated.Uint256;
import org.web3j.crypto.Hash;
import org.web3j.utils.Numeric;

import io.zksync.abi.TransactionEncoder;
import io.zksync.crypto.eip712.Eip712Domain;
import io.zksync.crypto.eip712.Eip712Encoder;
import io.zksync.helper.CounterContract;
import io.zksync.protocol.core.AccountType;
import io.zksync.protocol.core.ZkSyncNetwork;

public class DeployContractTest extends BaseTransactionTest {

    private static final byte[] BYTECODE = CounterContract.getCode();
    private static final Function FUNC = CounterContract.encodeIncrement(BigInteger.valueOf(123123));

    @Test
    public void testSerializeToEIP712() {
        DeployContract deployContract = buildDeployContract();
        List<Pair<String, Type<?>>> types = deployContract.eip712types();
        Iterator<Pair<String, Type<?>>> t = types.iterator();

        {
            Pair<String, Type<?>> t2 = t.next();
            assertEquals("accountType", t2.getKey());
            assertEquals(AccountType.ZkRollup.getType(), t2.getValue());
        }
        {
            Pair<String, Type<?>> t2 = t.next();
            assertEquals("bytecodeHash", t2.getKey());
            assertEquals(new Uint256(Numeric.toBigInt(Hash.sha3(BYTECODE))), t2.getValue());
        }
        {
            Pair<String, Type<?>> t2 = t.next();
            assertEquals("calldataHash", t2.getKey());
            assertEquals(new Uint256(Numeric.toBigInt(Hash.sha3(FunctionEncoder.encode(FUNC)))), t2.getValue());
        }
        super.assertSerializeToEIP712(t);
        {
            Pair<String, Type<?>> t2 = t.next();
            assertEquals("padding", t2.getKey());
            assertEquals(Uint256.DEFAULT, t2.getValue());
        }
    }

    @Test
    public void testEncodeToEIP712TypeString() {
        DeployContract deployContract = buildDeployContract();
        String result = Eip712Encoder.encodeType(deployContract.intoEip712Struct());

        assertEquals(
                "DeployContract(uint8 accountType,uint256 bytecodeHash,uint256 calldataHash,address initiatorAddress,address feeToken,uint256 fee,uint32 nonce,uint64 validFrom,uint64 validUntil,uint256 padding)",
                result);
    }

    @Test
    public void testSerializeToEIP712EncodedValue() {
        DeployContract deployContract = buildDeployContract();
        byte[] encoded = Eip712Encoder.encodeValue(deployContract.intoEip712Struct()).getValue();

        assertEquals("0x313228dd2323576aea6cc8cd056558ebca835cc1843433106a76ec75cbda6cc5",
                Numeric.toHexString(encoded));
    }

    @Test
    public void testSerializeToEIP712Message() {
        DeployContract deployContract = buildDeployContract();
        byte[] encoded = Eip712Encoder.typedDataToSignedBytes(Eip712Domain.defaultDomain(ZkSyncNetwork.Localhost),
                deployContract);

        assertEquals("0xe7b596fde369e5a2e71a1b021b895dac3481b4b68eb4038a7553c6c41b5aa203",
                Numeric.toHexString(encoded));
    }

    @Test
    public void testSerializeToEncodedFunction() {
        DeployContract deployContract = buildDeployContract();
        Function function = TransactionEncoder.encodeToFunction(deployContract);

        assertEquals(
                "0x85bd1cb90000000000000000000000000000000000000000000000000000000000000900000000000000000000000000000000000000000000000000000000000000002a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffffffff000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee000000000000000000000000000000000000000000000000000000000000007b0000000000000000000000007e5f4552091a69125d5dfcb7b8c2659029395bdf000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000010600000000000000000000000000000000000000000000000000000000000000fe00e000000e00000000000000000000000000000000000000000000000000000000c000802010000000000000000000000000000000000000000000000000000000c000802000000000000000000000000000000000000000000000000000000000e000800200000000000000000000000000000000000000000000000000000000e000800200100000000000000000000000000000000000000000000000000000e000800200300000000000000000000000000000000000000000000000000000c802000017c7ee91ae51bb0ed9b9e413333bf74f700000000000000000000000c80200000b75ee1170f6b7c3ce4583c65d82198c4000000000000000000000005020001010000000000000000000000000000000000000000000000000000000e004000010700000000000000000000000000000000000000000000000000001a0081000201000000000000000000000000000000000000000000000000000004100000000000000000000000000000000000000000000000000000000000000a000000040d001900000000000000000000000000000000000000000000000004080000000000000000000000000000000000000000000000000000000000000a0000000419000f0000000000000000000000000000000000000000000000000c004100018000000000000000000000000000000000000000000000000000000c004100000000000000000000000000000000000000000000000000000000000e000100200200000000000000000000000000000000000000000000000000000c004100010000000000000000000000000000000000000000000000000000000c004100000000000000000000000000000000000000000000000000000000000e000100000100000000000000000000000000000000000000000000000000000c004100010100000000000000000000000000000000000000000000000000000c0041000000000000000000000000000000000000000000000000000000000005020100000000000000000000000000000000000000000000000000000000000a000000016500650000000000000000000000000000000000000000000000000c004100010100000000000000000000000000000000000000000000000000000c0041000000000000000000000000000000000000000000000000000000000004100100000000000000000000000000000000000000000000000000000000000a000000041d006a00000000000000000000000000000000000000000000000004080000000000000000000000000000000000000000000000000000000000000a000000041f006a0000000000000000000000000000000000000000000000000c802000018000000000000000000000000000000000000000000000000000000c802000000000000000000000000000000000000000000000000000000000000e800000200200000000000000000000000000000000000000000000000000000c802000010000000000000000000000000000000000000000000000000000000c80200000000000000000000000000000ffffffff00000000000000000000000e008000010700000000000000000000000000000000000000000000000000001a888000020000000000000000000000000000000000000000000000000000000e0020000100000000000000000000000000000000000000000000000000000018802000000500000000000000000000000000000000000000000000000000000c000401010000000000000000000000000000000000000000000000000000000c000401000000000000000000000000003ce64c6d000000000000000000000004080400000000000000000000000000000000000000000000000000000000000a000000042c00460000000000000000000000000000000000000000000000000c00820001ffffffffffffffffffffffffffffffff00000000000000000000000c00820000ffffffffffffffffffffffffffffff7f000000000000000000000004020200000000000000000000000000000000000000000000000000000000000a000000086700300000000000000000000000000000000000000000000000000c000401010000000000000000000000000000000000000000000000000000000c0004010000000000000000000000000000000000000000000000000000000005102000010000000000000000000000000000000000000000000000000000000e800000200400000000000000000000000000000000000000000000000000000e000100000100000000000000000000000000000000000000000000000000000c008200012000000000000000000000000000000000000000000000000000000c008200000000000000000000000000000000000000000000000000000000000e000400600100000000000000000000000000000000000000000000000000000a000000013c003c000000000000000000000000000000000000000000000000022000010000000000000000000000000000000000000000000000000000000004020000000000000000000000000000000000000000000000000000000000000a0000000a3c0065000000000000000000000000000000000000000000000000180024000005000000000000000000000000000000000000000000000000000008022200000000000000000000000000000000000000000000000000000000000e020002210400000000000000000000000000000000000000000000000000000e020800000800000000000000000000000000000000000000000000000000000200040200010000000000000000000000000000000000000000000000000000020420000000000000000000000000000000000000000000000000000000000004200400000000000000000000000000000000000000000000000000000000000a000000023900440000000000000000000000000000000000000000000000000e002000610100000000000000000000000000000000000000000000000000000a000000013900390000000000000000000000000000000000000000000000000c004100012000000000000000000000000000000000000000000000000000000c004100000000000000000000000000000000000000000000000000000000000c000401010000000000000000000000000000000000000000000000000000000c0004010000000000000000000000000000000080000000000000000000000002108000000000000000000000000000000000000000000000000000000000000e0001006001000000000000000000000000000000000000000000000000000004020100000000000000000000000000000000000000000000000000000000000a000000024f004e00000000000000000000000000000000000000000000000002208000000000000000000000000000000000000000000000000000000000001a02240002000000000000000000000000000000000000000000000000000000021040000000000000000000000000000000000000000000000000000000000004020000000000000000000000000000000000000000000000000000000000000a00000008540053000000000000000000000000000000000000000000000000022040000000000000000000000000000000000000000000000000000000000004020400000000000000000000000000000000000000000000000000000000000a00000004570056000000000000000000000000000000000000000000000000020840000000000000000000000000000000000000000000000000000000000004040000000000000000000000000000000000000000000000000000000000000a0000000a6700590000000000000000000000000000000000000000000000000c00410001ffffffffffffffffffffffffffffffff00000000000000000000000c00410000ffffffffffffffffffffffffffffffff00000000000000000000000e002000010800000000000000000000000000000000000000000000000000001a020101080000000000000000000000000000000000000000000000000000000c004100010000000000000000000000000000000000000000000000000000000c00410000000000000000000000000000000000000000000000000000000000050480000100000000000000000000000000000000000000000000000000000004080400000000000000000000000000000000000000000000000000000000000a0000000662006c000000000000000000000000000000000000000000000000028820000000000000000000000000000000000000000000000000000000000005840000000000000000000000000000000000000000000000000000000000000e000100000100000000000000000000000000000000000000000000000000000e000000e100000000000000000000000000000000000000000000000000000007000000000000000000000000000000000000000000000000000000000000000c802000010000000000000000000000000000000000000000000000000000000c802000000000000000000000000000000000000000000000000000000000000e800000000100000000000000000000000000000000000000000000000000000e000000e100000000000000000000000000000000000000000000000000000007000000040000000000000000000000000000000000000000000000000000000c802000010000000000000000000000000000000000000000000000000000000c80200000000000000000000000000000717b484e00000000000000000000000e800000200000000000000000000000000000000000000000000000000000000c802000011100000000000000000000000000000000000000000000000000000c802000000000000000000000000000000000000000000000000000000000000e800000200100000000000000000000000000000000000000000000000000000c008200010200000000000000000000000000000000000000000000000000000c008200000000000000000000000000000000000000000000000000000000000e0002000001000000000000000000000000000000000000000000000000000018002100000500000000000000000000000000000000000000000000000000000e0000016101000000000000000000000000000000000000000000000000000008022400000000000000000000000000000000000000000000000000000000000e020001210000000000000000000000000000000000000000000000000000000e02040000080000000000000000000000000000000000000000000000000000020041000001000000000000000000000000000000000000000000000000000004040200000000000000000000000000000000000000000000000000000000000a0000000275007d0000000000000000000000000000000000000000000000000e000000e1000000000000000000000000000000000000000000000000000000070000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000247cf5dab0000000000000000000000000000000000000000000000000000000000001e0f300000000000000000000000000000000000000000000000000000000",
                FunctionEncoder.encode(function));
    }

    private DeployContract buildDeployContract() {
        DeployContract zkDeployContract = new DeployContract(
                AccountType.ZkRollup,
                Numeric.toHexString(BYTECODE),
                FunctionEncoder.encode(FUNC),
                SENDER.getAddress(),
                FEE_TOKEN.getAddress(),
                FEE,
                NONCE,
                VALIDITY_TIME);

        return zkDeployContract;
    }
}
