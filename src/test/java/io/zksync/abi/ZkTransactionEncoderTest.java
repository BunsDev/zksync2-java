package io.zksync.abi;

import static org.junit.jupiter.api.Assertions.*;

import java.math.BigInteger;

import io.zksync.transaction.fee.Fee;
import io.zksync.transaction.type.Transaction712;
import org.junit.Before;
import org.junit.Test;
import org.web3j.abi.FunctionEncoder;
import org.web3j.crypto.Credentials;
import org.web3j.crypto.ECKeyPair;
import org.web3j.utils.Convert;
import org.web3j.utils.Numeric;
import org.web3j.utils.Convert.Unit;

import io.zksync.helper.CounterContract;
import io.zksync.protocol.core.Token;
import io.zksync.transaction.DeployContract;
import io.zksync.transaction.Execute;
import io.zksync.transaction.Withdraw;

public class ZkTransactionEncoderTest {

    private static final Token ETH = Token.createETH();
    private static final Long CHAIN_ID = 270L;

    Credentials credentials;

    @Before
    public void setUp() {
        this.credentials = Credentials.create(ECKeyPair.create(BigInteger.ONE));
    }

    @Test
    public void testEncodeWithdraw() {
        Withdraw zkWithdraw = new Withdraw(
            ETH.getAddress(),
            this.credentials.getAddress(),
            Convert.toWei("1", Unit.ETHER).toBigInteger(),
            this.credentials.getAddress(),
            new Fee(ETH.getAddress()),
            BigInteger.ZERO
        );

        Transaction712<Withdraw> transaction = new Transaction712<>(CHAIN_ID, zkWithdraw);

        String expected = "0x70f852808080947e5f4552091a69125d5dfcb7b8c2659029395bdf880de0b6b3a76400008082010e94eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee94eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee8080c0";

        assertEquals(expected, Numeric.toHexString(TransactionEncoder.encode(transaction, null)));
    }

    @Test
    public void testEncodeDeploy() {
        DeployContract zkDeploy = new DeployContract(
            CounterContract.BINARY,
            this.credentials.getAddress(),
            new Fee(ETH.getAddress()),
            BigInteger.ZERO
        );

        Transaction712<DeployContract> transaction = new Transaction712<>(CHAIN_ID, zkDeploy);

        String expected = "0x70f9227c80808094000000000000000000000000000000000000000080b840bfe57faffa4e74de1fb8a60d0226141b98a25fb669b1dfdf99c77ad25591b5c8000000000000000001000000000000000000000000000000000000000000000082010e94eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee808080f92203b922000e0000000000000000e0050000000000000000000000000000000000000000000c000010001000000001000000000000000000000000000000000000000000000c000010001000000000000000000000000000000000000000000000000000000e000010000000000020000000000000000000000000000000000000000000000e000010000000000020010000000000000000000000000000000000000000000e000010000000000020030000000000000000000000000000000000000000000c0000020002000000017c7ee91ae51bb0ed9b9e413333bf74f70000000000000c000002000200000000b75ee1170f6b7c3ce4583c65d82198c40000000000000e0000020000000000600100000000000000000000000000000000000000000005020000000200000001000000000000000000000000000000000000000000000e000002000000000060050000000000000000000000000000000000000000000c0000020002000000010000000000000000ffffffffffffffff0000000000000c000002000200000000ffffffffffffffffffffffffffffffff0000000000000e000000000400000001000000000000000000000000000000000000000000000e000004000000000060020000000000000000000000000000000000000000001a040002000800000002000000000000000000000000000000000000000000000c000020002000000001000000000000000001000000000000000000000000000c000020002000000000000000000000000000000000000000000000000000000c000004000400000001010000000000000000000000000000000000000000000c0000040004000000000000000000000000000000000000000000000000000002040000000200000000000000000000000000000000000000000000000000000e000008000000000060030000000000000000000000000000000000000000000e0000200000000000600600000000000000000000000000000000000000000004080020000000000000000000000000000000000000000000000000000000000a0000000000000000041a00190000000000000000000000000000000000000002100000000200000000000000000000000000000000000000000000000000000e0000020000000000600400000000000000000000000000000000000000000002040000000200000000000000000000000000000000000000000000000000000e0000000020000000610500000000000000000000000000000000000000000004200000000000000000000000000000000000000000000000000000000000000a00000000000000000420001f0000000000000000000000000000000000000002100000000200000000000000000000000000000000000000000000000000000e0000000008000000610600000000000000000000000000000000000000000004200004000000000000000000000000000000000000000000000000000000000a000000000000000004230028000000000000000000000000000000000000000c000004000400000001000000000000000000000000000000000000000000000c00000400040000000000000000000000000000000083bbcae30000000000000e0000000010000000610300000000000000000000000000000000000000000004100008000000000000000000000000000000000000000000000000000000000a0000000000000000048600280000000000000000000000000000000000000004200000000000000000000000000000000000000000000000000000000000000a0000000000000000042a002f000000000000000000000000000000000000000c000004000400000001000000000000000000000000000000000000000000000c000004000400000000000000000000000000000000c9a6bc8e0000000000000e0000000010000000610200000000000000000000000000000000000000000004100008000000000000000000000000000000000000000000000000000000000a00000000000000000286002f000000000000000000000000000000000000000e000000000400000061040000000000000000000000000000000000000000001a020004000200000002000000000000000000000000000000000000000000000c000004000400000001800000000000000000000000000000000000000000000c000004000400000000000000000000000000000000000000000000000000000e0000040000000000200200000000000000000000000000000000000000000004020000000000000000000000000000000000000000000000000000000000000a00000000000000000a36003e000000000000000000000000000000000000000c000002000200000001000000000000000000000000000000000000000000000c000002000200000000000000000000000000000000000000000000000000000e000002000000000000000000000000000000000000000000000000000000000c000002000200000001010000000000000000000000000000000000000000000c000002000200000000000000000000000000000000000000000000000000000e0000000004000000610100000000000000000000000000000000000000000005040002000000000000000000000000000000000000000000000000000000000a000000000000000001840084000000000000000000000000000000000000000e000000000200000001000000000000000000000000000000000000000000001a000002000200000002fcffffff00000000000000000000000000000000000004020000000000000000000000000000000000000000000000000000000000000a0000000000000000048c0042000000000000000000000000000000000000000e0000000004000000010100000000000000000000000000000000000000000018000004000400000002e00000000000000000000000000000000000000000000c0000080008000000013ce64c6d0000000000000000000000000000000000000c0000080008000000000000000000000000000000000000000000000000000004040008000000000000000000000000000000000000000000000000000000000a00000000000000000448006b000000000000000000000000000000000000000c000002000200000001000000000000000000000000000000000000000000000c000002000200000000000000000000000000000000000000000000000000000e0000020000000000600100000000000000000000000000000000000000000005020000000100000001000000000000000000000000000000000000000000000e000000000200000021020000000000000000000000000000000000000000000e0000020000000000600400000000000000000000000000000000000000000007000000000000000003e80000000000000000000000000000000000000000000c000002000200000001200000000000000000000000000000000000000000000c000002000200000000000000000000000000000000000000000000000000000e000002000000000060030000000000000000000000000000000000000000000e000002000000000000000000000000000000000000000000000000000000000c000002000200000001010000000000000000000000000000000000000000000c000002000200000000000000000000000000000000000000000000000000000e000002000000000060020000000000000000000000000000000000000000000e000000000200000061010000000000000000000000000000000000000000000a0000000000000000015a005a0000000000000000000000000000000000000004040000000000000000000000000000000000000000000000000000000000000a00000000000000000a5a0084000000000000000000000000000000000000000e0000020000000000600600000000000000000000000000000000000000000018000002000400000000050000000000000000000000000000000000000000000e000004000000000060050000000000000000000000000000000000000000000e00000000020000006104000000000000000000000000000000000000000000020200040001000000000000000000000000000000000000000000000000000007000000000000000003c00000000000000000000000000000000000000000000e000000000200000061030000000000000000000000000000000000000000000e0000000004000000610500000000000000000000000000000000000000000008040002000200000000000000000000000000000000000000000000000000000e020001000000000000010000000000000000000000000000000000000000000e0000000008000000610600000000000000000000000000000000000000000002000008000200000000010000000000000000000000000000000000000000000e0000000004000000610200000000000000000000000000000000000000000004020008000000000000000000000000000000000000000000000000000000000a000000000000000002580069000000000000000000000000000000000000000e000000000400000061010000000000000000000000000000000000000000000a000000000000000001580058000000000000000000000000000000000000000c000008000800000001b0daf57c0000000000000000000000000000000000000c0000080008000000000000000000000000000000000000000000000000000004040008000000000000000000000000000000000000000000000000000000000a0000000000000000046f008c000000000000000000000000000000000000000c000004000400000001240000000000000000000000000000000000000000000c0000040004000000000000000000000000000000000000000000000000000004020004000000000000000000000000000000000000000000000000000000000a000000000000000002910073000000000000000000000000000000000000000c000002000200000001240000000000000000000000000000000000000000000c000002000200000000000000000000000000000000000000000000000000000e00000200000000006006000000000000000000000000000000000000000000020200000001000000000000000000000000000000000000000000000000000007000000000000000003d40000000000000000000000000000000000000000000c000002000200000001ffffffffffffffffffffffffffffffff0000000000000c000002000200000000ffffffffffffffffffffffffffffffff0000000000001a010002000400000008000000000000000000000000000000000000000000000c000008000800000001000000000000000000000000000000000000000000000c00000800080000000000000000000000000000000000000000000000000000050800000002000000010000000000000000000000000000000000000000000004020004000000000000000000000000000000000000000000000000000000000a000000000000000008960080000000000000000000000000000000000000000202000100020000000000000000000000000000000000000000000000000000050800000004000000010000000000000000000000000000000000000000000005080002000000000000000000000000000000000000000000000000000000000e000008000000000000000000000000000000000000000000000000000000000e0000000000000000e10500000000000000000000000000000000000000000007000000000000000000000000000000000000000000000000000000000000000c000002000200000001010000000000000000000000000000000000000000000c000002000200000000000000000000000000000000000000000000000000000e000002000000000000000000000000000000000000000000000000000000000e000004000000000000010000000000000000000000000000000000000000000e0000000000000000e10500000000000000000000000000000000000000000007000000000000000004000000000000000000000000000000000000000000000c000002000200000001000000000000000000000000000000000000000000000c000002000200000000000000000000000000000000000000000000000000000e000002000000000000000000000000000000000000000000000000000000000e0000000000000000e10500000000000000000000000000000000000000000007000000000000000004000000000000000000000000000000000000000000000c000002000200000001000000000000000000000000000000000000000000000c000002000200000000000000000000000000000000000000000000000000000e000002000000000000000000000000000000000000000000000000000000000e0000000000000000e10500000000000000000000000000000000000000000007000000000000000004000000000000000000000000000000000000000000000c000002000200000001000000000000000000000000000000000000000000000c000002000200000000000000000000000000000000717b484e0000000000000e000002000000000020000000000000000000000000000000000000000000000c000001000100000001110000000000000000000000000000000000000000000c000001000100000000000000000000000000000000000000000000000000000c000002000200000001040000000000000000000000000000000000000000000c000002000200000000000000000000000000000000000000000000000000000e0000080000000000600500000000000000000000000000000000000000000007000000000000000003e80000000000000000000000000000000000000000000e000000002000000061050000000000000000000000000000000000000000000e000000000200000061060000000000000000000000000000000000000000000e000002000000000000000000000000000000000000000000000000000000000c000002000200000001200000000000000000000000000000000000000000000c0000020002000000000000000000000000000000000000000000000000000002200000000400000000000000000000000000000000000000000000000000000a000000000000000001a900a900000000000000000000000000000000000000020800000004000000000000000000000000000000000000000000000000000004100000000000000000000000000000000000000000000000000000000000000a00000000000000000aa900b400000000000000000000000000000000000000180000040008000000000500000000000000000000000000000000000000000008080002000800000000000000000000000000000000000000000000000000000e080000001000000021000000000000000000000000000000000000000000000e0800100000000000000100000000000000000000000000000000000000000002000004000800000000010000000000000000000000000000000000000000000c000010001000000001010000000000000000000000000000000000000000000c0000100010000000000000000000000000000000000000000000000000000004080004000000000000000000000000000000000000000000000000000000000a000000000000000002a600b20000000000000000000000000000000000000002200000001000000000000000000000000000000000000000000000000000000a000000000000000001a600a6000000000000000000000000000000000000000c000002000200000001ffffffffffffffffffffffffffffffff0000000000000c000002000200000000ffffffffffffffffffffffff000000000000000000000e000000000400000001020000000000000000000000000000000000000000001a040002000200000002000000000000000000000000000000000000000000000c000004000400000001000000000000000000000000000000000000000000000c000004000400000000000000000000000000000000ffffffff0000000000000e000000000800000021010000000000000000000000000000000000000000001a080004000400000002000000000000000000000000000000000000000000001a040002000200000004000000000000000000000000000000000000000000000e000002000000000000020000000000000000000000000000000000000000000e0000000000000000e10500000000000000000000000000000000000000000007000000000000000004000000000000000000000000000000000000000000000c000002000200000001e0ffffffffffffffffffffffffffffff0000000000000c000002000200000000ffffffffffffffffffffffffffffffff0000000000001a010002000200000002000000000000000000000000000000000000000000000c000004000400000001200000000000000000000000000000000000000000000c0000040004000000000000000000000000000000000000000000000000000008020004000400000000000000000000000000000000000000000000000000001a0000010002000000021f00000000000000000000000000000000000000000018000002000800000000030000000000000000000000000000000000000000000e0400000002000000210000000000000000000000000000000000000000000004080000000000000000000000000000000000000000000000000000000000000a000000000000000004d200cb000000000000000000000000000000000000000c000010001000000001000100000000000000000000000000000000000000000c0000100010000000000000000000000000000000000000000000000000000004100008001000000000000000000000000000000000000000000000000000000e04000000040000002101000000000000000000000000000000000000000000181000040004000000020000000000000000000000000000000000000000000018080002000200000000000000000000000000000000000000000000000000001a04000200020000000400000000000000000000000000000000000000000000020200000001000000000000000000000000000000000000000000000000000007000000000000000000000000000000000000000000000000000000000000000c000002000200000001e0ffffffffffffffffffffffffffffff0000000000000c000002000200000000ffffffffffffffffffffffffffffffff0000000000001a010002000200000002000000000000000000000000000000000000000000000c000004000400000001200000000000000000000000000000000000000000000c0000040004000000000000000000000000000000000000000000000000000008020004000400000000000000000000000000000000000000000000000000001a0000010002000000021f00000000000000000000000000000000000000000018000002000800000000030000000000000000000000000000000000000000000e0400000002000000010000000000000000000000000000000000000000000004080000000000000000000000000000000000000000000000000000000000000a000000000000000004e600df000000000000000000000000000000000000000c000010001000000001000100000000000000000000000000000000000000000c0000100010000000000000000000000000000000000000000000000000000004100008001000000000000000000000000000000000000000000000000000000e04000000040000000101000000000000000000000000000000000000000000181000040004000000020000000000000000000000000000000000000000000018080002000200000000000000000000000000000000000000000000000000001a04000200020000000400000000000000000000000000000000000000000000020200000001000000000000000000000000000000000000000000000000000007000000000000000000000000000000000000000000000000000000000000000e0000000000000000e0010000000000000000000000000000000000000000000c000004000400000001e0ffffffffffffffffffffffffffffff0000000000000c000004000400000000ffffffffffffffffffffffffffffffff0000000000001a020004000400000002000000000000000000000000000000000000000000000c000008000800000001200000000000000000000000000000000000000000000c0000080008000000000000000000000000000000000000000000000000000008040008000400000000000000000000000000000000000000000000000000001a0000020002000000021f00000000000000000000000000000000000000000018000002000200000000030000000000000000000000000000000000000000000c000008000800000001000100000000000000000000000000000000000000000c0000080008000000000000000000000000000000000000000000000000000004080002000800000000000000000000000000000000000000000000000000000e000008000000000060020000000000000000000000000000000000000000000c000020002000000001ffffffffffffffffffffffffffffffff0000000000000c000020002000000000ffffffffffffffffffffffffffffffff000000000000020100000008000000000000000000000000000000000000000000000000000004020000000000000000000000000000000000000000000000000000000000000a0000000000000000040001fa000000000000000000000000000000000000000e0000000008000000610200000000000000000000000000000000000000000018080020000800000000000000000000000000000000000000000000000000000e040000001000000021000000000000000000000000000000000000000000001a1000080008000000020000000000000000000000000000000000000000000018020001001000000002000000000000000000000000000000000000000000001a100008000800000004000000000000000000000000000000000000000000000e0400000010000000210100000000000000000000000000000000000000000004020000000000000000000000000000000000000000000000000000000000000a0000000000000000040c0103010000000000000000000000000000000000000e000020000000000060010000000000000000000000000000000000000000000e0000000020000000610200000000000000000000000000000000000000000018200001002000000000000000000000000000000000000000000000000000000e000020000000000060020000000000000000000000000000000000000000000e0000000020000000610100000000000000000000000000000000000000000018020020000200000002000000000000000000000000000000000000000000001a100002000200000002000000000000000000000000000000000000000000000e000000001000000061020000000000000000000000000000000000000000001a100002001000000004000000000000000000000000000000000000000000000e040010000000000020010000000000000000000000000000000000000000000e040008000000000020000000000000000000000000000000000000000000000e0000000000000000e1010000000000000000000000000000000000000000000700000000000000000000000000000000000000000000000000000000000000";

        assertEquals(expected, Numeric.toHexString(TransactionEncoder.encode(transaction, null)));
    }

    @Test
    public void testEncodeExecute() {
        Execute zkExecute = new Execute(
            "0xeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee",
            FunctionEncoder.encode(CounterContract.encodeIncrement(BigInteger.valueOf(42L))),
            "0xe1fab3efd74a77c23b426c302d96372140ff7d0c",
            new Fee(ETH.getAddress()),
            BigInteger.ZERO
        );

        Transaction712<Execute> transaction = new Transaction712<>(CHAIN_ID, zkExecute);

        String expected = "0x70f85a80808094eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee80a47cf5dab0000000000000000000000000000000000000000000000000000000000000002a82010e94eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee808080c0";

        assertEquals(expected, Numeric.toHexString(TransactionEncoder.encode(transaction, null)));
    }
}
